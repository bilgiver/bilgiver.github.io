name: Update Exchange Rates

on:
  schedule:
    - cron: '45 15 * * *'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Fetch XML and convert to JSON
        run: |
          xml_content=$(curl -s https://tcmb.org.tr/kurlar/today.xml)
          
          # XML içeriğini işlemek için basit bir betik
          node -e "
            const { JSDOM } = require('jsdom');
            const fs = require('fs');
            const xmlData = \`$xml_content\`;

            try {
              const parser = new JSDOM().window.DOMParser;
              const xmlDoc = parser.parseFromString(xmlData, 'text/xml');
              
              if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                console.error('XML parse hatası.');
                process.exit(1);
              }

              const currencies = xmlDoc.getElementsByTagName('Currency');
              const rates = {};
              
              for (const currency of currencies) {
                  const code = currency.getAttribute('CurrencyCode');
                  if (code === 'USD' || code === 'EUR') {
                      rates[code] = {
                          name: currency.getElementsByTagName('Isim')[0].textContent,
                          buying: currency.getElementsByTagName('ForexBuying')[0].textContent,
                          selling: currency.getElementsByTagName('ForexSelling')[0].textContent
                      };
                  }
              }
              
              fs.writeFileSync('data/exchange_rates.json', JSON.stringify(rates, null, 2));
              console.log('Döviz kurları başarıyla güncellendi!');
            } catch (error) {
              console.error('Hata:', error);
              process.exit(1);
            }
          "

      - name: Commit changes
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add data/exchange_rates.json
          git commit -m "Güncel döviz kurları eklendi." || echo "Değişiklik yok."
          git push